apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Values.name }}-backup
  namespace: {{ .Values.namespace }}
spec:
  schedule: {{ .Values.backup.schedule | quote }}
  concurrencyPolicy: {{ .Values.backup.concurrencyPolicy }}
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: {{ .Values.backup.ttlSecondsAfterFinished }}
      backoffLimit: {{ .Values.backup.backoffLimit }}
      template:
        spec:
          containers:
            - name: {{ .Values.name }}-backup
              image: postgres:{{ .Values.backup.database.postgresVersion }}-alpine
              command: ["/bin/sh", "-c"]
              args:
                - |
                  set -e -o pipefail

                  apk add --no-cache aws-cli curl

                  BACKUP_FILE_NAME="${PGDATABASE}-$(date +%F-%H_%M_%S).sql.gz"
                  S3_URI="s3://${BUCKET}/${PATH}/${BACKUP_FILE_NAME}"

                  echo "Dumping cluster to ${BACKUP_FILE_NAME}..."
                  pg_dumpall --clean --if-exists | gzip > "/tmp/${BACKUP_FILE_NAME}"

                  echo "Uploading to ${S3_URI}..."
                  aws --endpoint-url https://${ENDPOINT} s3 cp "/tmp/${BACKUP_FILE_NAME}" "${S3_URI}"
                  echo "Upload successful."

                  if [ -n "$BACKUP_HEARTBEAT" ]; then
                    echo "Sending heartbeat to $BACKUP_HEARTBEAT..."
                    RESPONSE=$(curl -m 10 --retry 5 -sS "$BACKUP_HEARTBEAT")
                    echo "Response body: $RESPONSE"
                  fi

                  rm "/tmp/${BACKUP_FILE_NAME}"
              envFrom:
                - secretRef:
                    name: {{ .Values.name }}-backup
                - secretRef:
                    name: {{ .Values.name }}-heartbeat
              env:
                - name: PGHOST
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.backup.database.secretName }}
                      key: DATABASE_HOST
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.backup.database.secretName }}
                      key: DATABASE_USER
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.backup.database.secretName }}
                      key: DATABASE_PASS
                - name: PGDATABASE
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.backup.database.secretName }}
                      key: DATABASE_NAME
          restartPolicy: OnFailure
