{{- range $k, $clusterConfig := .Values.clusters }}
{{- $port := $clusterConfig.port | default 5432 }}

{{- /* Extract database name and owner from bootstrap configuration */ -}}
{{- $database := "app" }}
{{- $username := "app" }}
{{- if and $clusterConfig.bootstrap $clusterConfig.bootstrap.initdb }}
  {{- if $clusterConfig.bootstrap.initdb.database }}
    {{- $database = $clusterConfig.bootstrap.initdb.database }}
  {{- end }}
  {{- if $clusterConfig.bootstrap.initdb.owner }}
    {{- $username = $clusterConfig.bootstrap.initdb.owner }}
  {{- end }}
{{- else if and $clusterConfig.bootstrap $clusterConfig.bootstrap.recovery }}
  {{- if $clusterConfig.bootstrap.recovery.database }}
    {{- $database = $clusterConfig.bootstrap.recovery.database }}
  {{- end }}
  {{- if $clusterConfig.bootstrap.recovery.owner }}
    {{- $username = $clusterConfig.bootstrap.recovery.owner }}
  {{- end }}
{{- end }}

{{- /* Build connection host */ -}}
{{- $host := printf "%s-rw.%s:%d" $clusterConfig.clusterName $.Values.namespace $port }}

{{- /* Build SSL parameters */ -}}
{{- $sslParams := "sslmode=verify-full&sslfactory=org.postgresql.ssl.LibPQFactory" }}
{{- $sslRootCertParams := "sslmode=verify-full&sslrootcert=/etc/secrets/ca/ca.crt" }}

{{- /* Build pgpass host */ -}}
{{- $pgpassHost := printf "%s-rw:%d" $clusterConfig.clusterName $port }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ $clusterConfig.clusterName }}
  namespace: {{ $.Values.namespace }}
spec:
  # How often to rotate the database password
  refreshInterval: "24h"
  target:
    name: {{ $clusterConfig.clusterName }}
    creationPolicy: Owner
    template:
      metadata:
        labels:
          cnpg.io/reload: "true"
      engineVersion: v2
      data:
        username: "{{ $username }}"
        password: "{{ `{{ .password }}` }}"
        pgpass: "{{ $pgpassHost }}:{{ $database }}:{{ $username }}:{{ `{{ .password }}` }}"
        jdbc-uri: "jdbc:postgresql://{{ $host }}/{{ $database }}?password={{ `{{ .password }}` }}&user={{ $username }}&{{ $sslParams }}"
        uri: "postgresql://{{ $username }}:{{ `{{ .password }}` }}@{{ $host }}/{{ $database }}?{{ $sslRootCertParams }}"
  dataFrom:
    - sourceRef:
        generatorRef:
          apiVersion: generators.external-secrets.io/v1alpha1
          kind: Password
          name: pg-password-generator
{{- end }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: b2-backup-credentials
  namespace: {{ .Values.namespace }}
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-secret-store
  target:
    creationPolicy: Owner
  data:
    - secretKey: AWS_ACCESS_KEY_ID
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        key: b2-secret-cloudnative-pg
        metadataPolicy: None
        property: AWS_ACCESS_KEY_ID
    - secretKey: AWS_SECRET_ACCESS_KEY
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        key: b2-secret-cloudnative-pg
        metadataPolicy: None
        property: AWS_SECRET_ACCESS_KEY
