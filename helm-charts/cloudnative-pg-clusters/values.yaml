name: cloudnative-pg-clusters
namespace: cnpg-system

backup:
  enabled: true
  b2:
    bucket: github-otaru-cloudnative-pg-backup
    endpoint: https://s3.eu-central-003.backblazeb2.com

defaults:
  cluster:
    instances: 1
    storage:
      size: 5Gi
      storageClass: longhorn-crypto-global
    backup:
      target: primary
      retentionPolicy: 2d
    plugins:
      - enabled: true
        isWALArchiver: false
        name: barman-cloud.cloudnative-pg.io
        parameters:
          barmanObjectName: b2-backup
    postgresql: &postgresql
      pg_hba: # Default pg_hba configuration for certificate-only authentication
        - hostssl all all 0.0.0.0/0 cert
        - hostssl all all ::0/0 cert
  scheduledBackup:
    enabled: true
    schedule: "0 0 2 * * *"
  objectStore:
    retentionPolicy: 2d

clusters:
  # https://cloudnative-pg.io/documentation/current/recovery/#restoring-into-a-cluster-with-a-backup-section
  # Avoid reusing the same ObjectStore configuration for both backup and recovery in the same cluster. If you must, ensure that each cluster uses a unique serverName
  # to prevent accidental overwrites of backup data.
#  example-db:
#    # naming convention: $clusterName-$date-$time
#    clusterName: &exampleDBClusterName example-db-20250724-0023
#    namespace: cnpg-system
#    postgresql:
#      <<: *postgresql
#      pg_hba: # Use password authentication
#        - hostssl all all 0.0.0.0/0 scram-sha-256
#        - hostssl all all ::0/0 scram-sha-256
#    test:
#      enabled: true
#      query: SELECT * FROM users;
#    bootstrap:
#      recovery:
#        source: &source backup-source
#        secret:
#          name: *exampleDBClusterName
#    externalClusters:
#      - name: *source
#        plugin:
#          enabled: true
#          name: barman-cloud.cloudnative-pg.io
#          parameters:
#            barmanObjectName: b2-backup
#            serverName: *exampleDBClusterName # cluster name to restore from

  teslamate:
    clusterName: &teslamateClusterName teslamate-20251024-0015
    labels:
      cnpg.io/reload: "true"
      cnpg.io/skipEmptyWalArchiveCheck: "true"
    namespace: teslamate
    postgresql:
      <<: *postgresql
      pg_hba: # Use password authentication
        - hostssl all all 0.0.0.0/0 scram-sha-256
        - hostssl all all ::0/0 scram-sha-256
    enableSuperuserAccess: true
    managed:
      roles:
        - name: app
          ensure: present
          superuser: true
          login: true
          connectionLimit: -1
          inherit: true
    test:
      enabled: true
      query: SELECT name FROM cars;
    bootstrap:
      initdb:
        database: teslamate
        owner: app
        secret:
          name: *teslamateClusterName
