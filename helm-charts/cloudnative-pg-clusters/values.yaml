name: cloudnative-pg-clusters
namespace: cnpg-system

backup:
  b2:
    bucket: github-otaru-cloudnative-pg-backup
    endpoint: https://s3.eu-central-003.backblazeb2.com

defaults:
  cluster:
    annotations:
      cnpg.io/skipEmptyWalArchiveCheck: enabled
    instances: 2
    storage:
      size: 1Gi
      storageClass: longhorn-crypto-global
    backup:
      target: primary
      retentionPolicy: 2d
    plugins:
      - enabled: true
        name: barman-cloud.cloudnative-pg.io
        isWALArchiver: true
        parameters:
          barmanObjectName: b2-backup
    postgresql:
      # Default pg_hba configuration for certificate-only authentication
      pg_hba:
        - hostssl all all 0.0.0.0/0 cert
        - hostssl all all ::0/0 cert
    test:
      enabled: false
  scheduledBackup:
    enabled: true
    schedule: "0 2 * * *"
  objectStore:
    retentionPolicy: 2d
    wal:
      maxParallel: 8
    instanceSidecarConfiguration:
      retentionPolicyIntervalSeconds: 1800

clusters:
  # https://cloudnative-pg.io/documentation/current/recovery/#restoring-into-a-cluster-with-a-backup-section
  # Avoid reusing the same ObjectStore configuration for both backup and recovery in the same cluster. If you must, ensure that each cluster uses a unique serverName
  # to prevent accidental overwrites of backup or WAL archive data.
  example-db:
    # naming convention: $clusterName-$date-$time
    clusterName: &clusterName example-db-20250724-0023
    postgresql:
      # Use password authentication
      pg_hba:
        - hostssl all all 0.0.0.0/0 scram-sha-256
        - hostssl all all ::0/0 scram-sha-256
    test:
      enabled: true
      query: SELECT * FROM users;
    bootstrap:
      recovery:
        source: &source backup-source
        secret:
          name: *clusterName
    externalClusters:
      - name: *source
        plugin:
          enabled: true
          isWALArchiver: true
          name: barman-cloud.cloudnative-pg.io
          parameters:
            barmanObjectName: b2-backup
            serverName: example-db-20250723-2256 # cluster name to restore from
