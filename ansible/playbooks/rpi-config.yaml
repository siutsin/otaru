---
- hosts: raspberrypi
  become: true

  tasks:
    - name: Load dm_crypt Kernel Module
      command: modprobe dm_crypt
      changed_when: false

    - name: Download WiringPi DEB package
      get_url:
        url: "https://github.com/WiringPi/WiringPi/releases/download/2.61-1/wiringpi-2.61-1-arm64.deb"
        dest: "/tmp/wiringpi-2.61-1-arm64.deb"
      register: download_result
      until: download_result is succeeded
      retries: 3
      delay: 5

    - name: Install WiringPi
      apt:
        deb: "/tmp/wiringpi-2.61-1-arm64.deb"
      register: install_result
      until: install_result is succeeded

    - name: Verify WiringPi installation
      command: gpio -v

    - name: Install bcm2835
      block:
        - get_url:
            url: "https://www.airspayce.com/mikem/bcm2835/bcm2835-1.73.tar.gz"
            dest: "/tmp/bcm2835-1.73.tar.gz"
          register: download_result
          until: download_result is succeeded
          retries: 3
          delay: 5
        - unarchive:
            src: "/tmp/bcm2835-1.73.tar.gz"
            dest: "/tmp"
            remote_src: yes
        - shell:
            cmd: |
              cd /tmp/bcm2835-1.73
              ./configure
              make
              make check
              make install

    - name: Display Info on OLED Display
      block:
        - git:
            repo: 'https://github.com/siutsin/Waveshare_PoE_HAT-B.git'
            dest: '/tmp/Waveshare_PoE_HAT-B'
          register: git_result
          until: git_result is succeeded
          retries: 3
          delay: 5
        - shell:
            cmd: bash /tmp/Waveshare_PoE_HAT-B/setup.sh
          become: yes
          become_user: pi

    - name: Ensure POE-HAT service is running
      systemd:
        name: poe-hat.service
        state: started
        enabled: yes
      register: poe_hat_service_status
      failed_when: poe_hat_service_status.state != 'started'
