---
- hosts: localhost
  connection: local

  tasks:
    - name: Restart all DaemonSets
      shell: "kubectl get namespaces -o custom-columns=':metadata.name' --no-headers | xargs -n2 -I {} kubectl rollout restart daemonsets -n {}"

    - name: Wait for cilium to rollout
      shell: "kubectl rollout status ds/cilium -n kube-system --timeout=15m"

    - name: Wait for cilium-envoy to rollout
      shell: "kubectl rollout status ds/cilium-envoy -n kube-system --timeout=15m"

    - name: Restart all Deployments and StatefulSets
      shell: "kubectl get namespaces -o custom-columns=':metadata.name' --no-headers | xargs -n2 -I {} kubectl rollout restart deployments,statefulsets -n {}"

    - name: Wait for cilium-operator to rollout
      shell: "kubectl rollout status deploy/cilium-operator -n kube-system --timeout=15m"
