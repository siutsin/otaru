package_update: true
package_upgrade: true

packages:
  - net-tools

write_files:
  - path: /etc/systemd/system/etcd.service
    permissions: '0644'
    content: |
      [Unit]
      Description=etcd key-value store
      Documentation=https://github.com/etcd-io/etcd
      After=network.target

      [Service]
      ExecStart=/usr/local/bin/etcd --advertise-client-urls=http://__IP_PLACEHOLDER__:2379 --listen-client-urls=http://__IP_PLACEHOLDER__:2379,http://127.0.0.1:2379
      Restart=always
      RestartSec=5
      LimitNOFILE=40000

      [Install]
      WantedBy=multi-user.target

runcmd:
  - |
    # wait until enp0s2 interface is ready 
    while true; do
        ip_address=$(ifconfig enp0s2 | grep 'inet ' | awk '{print $2}')
        [ -n "$ip_address" ] && break
        sleep 2
    done
    export IP_ADDRESS=$ip_address
    sed -i "s|__IP_PLACEHOLDER__|$IP_ADDRESS|g" /etc/systemd/system/etcd.service

  - ETCD_VERSION=$(curl -s https://api.github.com/repos/etcd-io/etcd/releases/latest | grep tag_name | cut -d '"' -f 4)
  - curl -L https://github.com/etcd-io/etcd/releases/download/${ETCD_VERSION}/etcd-${ETCD_VERSION}-linux-arm64.tar.gz -o /tmp/etcd.tar.gz
  - tar -xvf /tmp/etcd.tar.gz -C /tmp/
  - mv /tmp/etcd-v*/etcd /tmp/etcd-v*/etcdctl /usr/local/bin/
  - rm -rf /tmp/etcd*

  - systemctl daemon-reload
  - systemctl enable etcd
  - systemctl start etcd

  - etcd --version
  - etcdctl version
  - systemctl status etcd --no-pager
