package_update: true
package_upgrade: true

packages:
  - net-tools

runcmd:
  - |
    # wait until enp0s2 interface is ready 
    while true; do
        ip_address=$(ifconfig enp0s2 | grep 'inet ' | awk '{print $2}')
        [ -n "$ip_address" ] && break
        sleep 2
    done
  - |
    # install k3s
    ip=$(ifconfig enp0s2 | grep 'inet ' | awk '{print $2}')
    while true; do
      fail=$(curl --interface enp0s2 -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.30.3+k3s1 sh -s - \
        --disable metrics-server \
        --disable servicelb \
        --disable traefik \
        --disable-kube-proxy \
        --disable-network-policy \
        --flannel-backend=none \
        --secrets-encryption \
        --tls-san "$ip" \
        --write-kubeconfig-mode=644 \
        2>&1 | grep "Download failed"
      )
      if [ -z "$fail" ]; then
        break
      fi
      echo "retry in 2 seconds..."
      sleep 2
    done
  - echo "alias k='kubectl'" >> /home/ubuntu/.bash_aliases
